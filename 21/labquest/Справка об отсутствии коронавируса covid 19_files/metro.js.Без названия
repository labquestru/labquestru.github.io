ymaps.modules.define("TransportMap",["util.extend","transportMap.Scheme","transportMap.SchemeView","transportMap.SchemeLayer","transportMap.StationCollection","transportMap.AnnotationCollection","event.Manager","projection.Cartesian","Map"],(function(t,e,i,o,n,s,a,h,r,c){function l(t,e,i,o){return this._schemeId=this._schemeIdByCity[t]||t,this._container="string"==typeof e?document.getElementById(e):e[0]||e,o||(o=i,i=null),this._initStateAndOptions(i,o),this._loadScheme().then(this._onSchemeLoad.bind(this))}l.create=function(t,e,i,o){return new l(t,e,i,o)},e(l.prototype,{_initStateAndOptions:function(t,i){this._options=e({path:"node_modules/metro-data/",shadeOnSelect:!1,selectOnClick:!0,minZoom:0,maxZoom:3},i),this._state=e({shaded:!1,center:[0,0],selection:[]},t),this._state.hasOwnProperty("zoom")||(this._state.zoom=n.getFitZoom(this._container)),this._state.hasOwnProperty("zoom")||(this._state.zoom=n.getFitZoom(this._container))},_loadScheme:function(){return i.create([this._options.path,this._schemeId,".",this._options.lang,".svg"].join(""))},_onSchemeLoad:function(t){return this._createMap().then(function(e){return this._scheme=t,this._schemeView=new o(t),this._map=e,this._map.layers.add(new n(this._schemeView)),this.stations=new s(this._schemeView,this._options.selectOnClick),this._map.geoObjects.add(this.stations),this.stations.select(this._state.selection),this.annotations=new a(this),this.events=new h,this._map.events.setParent(this.events),this._options.shadeOnSelect&&this.stations.events.add("selectionchange",(function(){var t=this.stations.getSelection().length;1===t?this.shade():0===t&&this.unshade()}),this),this._state.shaded&&this.shade(),this}.bind(this))},_createMap:function(){var t=new ymaps.vow.Deferred,e=new c(this._container,{controls:[],center:this._state.center,zoom:this._state.zoom,type:null},{minZoom:this._options.minZoom,maxZoom:this._options.maxZoom,autoFitToViewport:"always",avoidFractionalZoom:!1,projection:new r([[-1,-1],[1,1]])});return this._container.clientWidth&&this._container.clientHeight?t.resolve(e):e.events.once("sizechange",function(){Number.isFinite(this._state.zoom)||e.setZoom(n.getFitZoom(this._container)),t.resolve(e)}.bind(this)),t.promise()},shade:function(){this._schemeView.fadeIn(),this.events.fire("shadechange",{type:"shade",target:this})},unshade:function(){this._schemeView.fadeOut(),this.events.fire("shadechange",{type:"unshade",target:this})},getCenter:function(){return this._map.getCenter()},setCenter:function(){return this._map.setCenter.apply(this._map,arguments)},getZoom:function(){return this._map.getZoom()},setZoom:function(){return this._map.setZoom.apply(this._map,arguments)},getSchemeId:function(){return this._schemeId},_schemeIdByCity:{moscow:1,spb:2,kiev:8,kharkov:9,minsk:13},getMap:function(){return this._map},destroy:function(){this._map.destroy()}}),t(l)})),ymaps.modules.define("transportMap.Annotation",["util.extend","util.augment","geometry.Point","Placemark","layout.storage","templateLayoutFactory"],(function(t,e,i,o,n,s,a){function h(t,i,o){h.superclass.constructor.call(this,t,e({arrowColor:this._getArrowColor(i.iconColor),textColor:this._getTextColor(i.iconColor)},i),e({iconLayout:"transportMap#annotation"},o))}function r(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(e+":"+t[e]);return i.join(";")}i(h,n,{_getRGBA:function(t){var e;return this._ctx||((e=document.createElement("canvas")).width=e.height=1,this._ctx=e.getContext("2d")),this._ctx.clearRect(0,0,1,1),this._ctx.fillStyle=t,this._ctx.fillRect(0,0,1,1),Array.prototype.slice.apply(this._ctx.getImageData(0,0,1,1).data)},_getArrowColor:function(t){var e=this._getRGBA(t).map((function(t){return Math.floor(.9*t)}));return e[3]=1,"rgba("+e+")"},_getTextColor:function(t){var e=this._getRGBA(t);return(e[0]+e[1]+e[2])/3>128?"rgba(0, 0, 0, 0.9)":"white"}});var c=["-moz-","-webkit-","-o-","-ms-",""].reduce((function(t,e){return t[e+"transform"]="rotate(45deg) skewX(75deg)",t}),{position:"absolute",content:"",width:"100px",height:"100px","background-color":'{{ properties.arrowColor|default:"white" }}',left:"-110px",top:"-143px","z-index":-1});s.add("transportMap#annotation",a.createClass('<ymaps class="ymaps-tm-annotation" style="'+r({overflow:"hidden",position:"absolute",left:'{{ options.offset.0|default:"-71" }}px',top:'{{ options.offset.1|default:"-108" }}px',height:"110px"})+'"><ymaps class="ymaps-tm-annotation-content" style="'+r({color:'{{ properties.textColor|default:"black"}}',"font-family":"Arial,Helvetica,sans-serif",background:'{{ properties.iconColor|default:"white" }}',"white-space":"nowrap",display:"block",padding:"10px"})+'">{{ properties.iconContent }}</ymaps><ymaps class="ymaps-tm-annotation-arrow" style="'+r(c)+'"></ymaps></ymaps>',{})),t(h)})),ymaps.modules.define("transportMap.AnnotationCollection",["util.augment","Collection"],(function(t,e,i){function o(t){o.superclass.constructor.call(this),this._map=t}e(o,i,{getMap:function(){return this._map}}),t(o)})),ymaps.modules.define("transportMap.Scheme",["vow","util.extend"],(function(t,e,i){var o=function(t){return this._load(t)};o.create=function(t){return new o(t)},i(o.prototype,{_load:function(t){var i,o,n=new XMLHttpRequest,s=new e.Deferred;return n.onreadystatechange=function(){if(4===n.readyState)try{i=this._text=n.responseText,this._node=(new DOMParser).parseFromString(i,"text/xml").firstChild,o=this._node.getElementsByTagName("metadata")[0],this._metaData=JSON.parse(o.firstChild.data),s.resolve(this)}catch(t){s.reject(t)}}.bind(this),n.onerror=function(t){s.reject(t)},n.open("GET",t,!0),n.send(null),s.promise()},createDom:function(){return this._node.cloneNode(!0)},getCity:function(){return this._metaData.name},getSize:function(){return[this._metaData.width,this._metaData.height]},getStations:function(){return this._metaData.stations},getLabel:function(t){return this._metaData.labels[t]}}),t(o)})),ymaps.modules.define("transportMap.SchemeLayer",["util.augment","collection.Item","transportMap.SchemeView"],(function(t,e,i,o){function n(t){n.superclass.constructor.call(this),this._schemeView=t}e(n,i,{onAddToMap:function(t){n.superclass.onAddToMap.call(this,t),this._pane=t.panes.get("ground"),this._updateSchemePosition(),this._pane.events.add(["viewportchange","zoomchange","clientpixelschange"],this._updateSchemePosition,this),this._pane.getElement().appendChild(this._schemeView.getNode())},_updateSchemePosition:function(){this._schemeView.updatePosition(this._pane.toClientPixels([0,0]),Math.pow(2,this._pane.getZoom()))},getSchemeView:function(){return this._schemeView}}),n.getFitZoom=function(t){return Math.log(Math.min(t.clientWidth/o.ZERO_ZOOM_SIZE,t.clientHeight/o.ZERO_ZOOM_SIZE))/Math.LN2},t(n)})),ymaps.modules.define("transportMap.SchemeView",["util.extend"],(function(t,e){function i(t){this._scheme=t,this._selfSize=t.getSize(),this._zeroZoomScale=Math.min(o/this._selfSize[0],o/this._selfSize[1]),this._offset=[Math.floor((o-this._selfSize[0]*this._zeroZoomScale)/2),Math.floor((o-this._selfSize[1]*this._zeroZoomScale)/2)],this._node=document.createElement("ymaps"),e(this._node.style,{position:"absolute",width:this._selfSize[0]+"px",height:this._selfSize[1]+"px"}),this._schemeNode=t.createDom(),this._schemeNode.setAttribute("width","100%"),this._schemeNode.setAttribute("height","100%"),this._schemeNode.setAttribute("viewBox",[0,0,this._selfSize[0],this._selfSize[1]].join(" ")),this._node.appendChild(this._schemeNode)}var o=256;i.ZERO_ZOOM_SIZE=o,e(i.prototype,{fadeOut:function(){this._schemeNode.getElementById("scheme-layer").style.opacity=""},fadeIn:function(){this._schemeNode.getElementById("scheme-layer").style.opacity=.5},updatePosition:function(t,i){var o=this._zeroZoomScale*i,n=[this._offset[0]+t[0],this._offset[1]+t[1]],s="translate("+n[0]+"px,"+n[1]+"px)";["-webkit-","-moz-","-ms-","-o-",""].forEach((function(t){this._node.style[t+"transform-origin"]="0px 0px",this._node.style[t+"transform"]=s}),this),e(this._node.style,{width:this._selfSize[0]*o+"px",height:this._selfSize[1]*o+"px"})},getNode:function(){return this._node},getScheme:function(){return this._scheme},getSchemeNode:function(){return this._schemeNode},toClientPixels:function(t,e){var i=Math.pow(2,e),o=[t[0]/i,t[1]/i];return[o[0]/this._zeroZoomScale-this._offset[0],o[1]/this._zeroZoomScale-this._offset[1]]},fromClientPixels:function(t,e){var i=[(t[0]+this._offset[0])*this._zeroZoomScale,(t[1]+this._offset[1])*this._zeroZoomScale],o=Math.pow(2,e);return[i[0]*o,i[1]*o]}}),t(i)})),ymaps.modules.define("transportMap.Station",["util.augment","vow","collection.Item","Rectangle"],(function(t,e,i,o,n){function s(t,e,i){s.superclass.constructor.call(this,i),this._schemeView=e,this.code=t.labelId,this.title=t.name,this.selected=!1,this._annotations=[]}e(s,o,{onAddToMap:function(){s.superclass.onAddToMap.apply(this,arguments),this._getGeoObjects().forEach((function(t){t.events.setParent(this.events)}),this)},getLabelNode:function(){return this._schemeView.getSchemeNode().getElementById("label-"+this.code)},getNode:function(){return this._schemeView.getSchemeNode().getElementById("station-"+this.code)},select:function(){var t;this.selected||(t=this.getLabelNode().getElementsByTagName("rect")[0],this.selected=!0,t.style.stroke="#bbb",t.style.opacity=1,this._appendTo("highlight-layer-stations",this._getStationNodes()),this._appendTo("highlight-layer-labels",this.getLabelNode()),this.events.fire("selectionchange",{type:"select",target:this}))},deselect:function(){var t;this.selected&&(t=this.getLabelNode().getElementsByTagName("rect")[0],this.selected=!1,t.style.stroke="",t.style.opacity="",this._appendTo("scheme-layer-stations",this._getStationNodes()),this._appendTo("scheme-layer-labels",this.getLabelNode()),this.events.fire("selectionchange",{type:"deselect",target:this}))},_appendTo:function(t,e){var i=this._schemeView.getSchemeNode().getElementById(t);[].concat(e).forEach((function(t){i.appendChild(t)}))},_getGeoObjects:function(){return[this.getLabelNode()].concat(this._getStationNodes()).map(this._createGeoObject,this)},_getStationNodes:function(){return this._schemeView.getScheme().getLabel(this.code).stationIds.map((function(t){return this._schemeView.getSchemeNode().getElementById("station-"+t)}),this)},_createGeoObject:function(t){var e=new n(this._getGeoBBox(t),{},{fill:!0,opacity:0});return this.getMap().geoObjects.add(e),e},_getGeoBBox:function(t){var e=this._schemeView,i=this.getMap().options.get("projection"),o=this.getMap().getZoom(),n=t.getBBox();return[i.fromGlobalPixels(e.fromClientPixels([n.x,n.y],o),o),i.fromGlobalPixels(e.fromClientPixels([n.x+n.width,n.y+n.height],o),o)]},getPosition:function(){var t=this._getGeoBBox(this.getNode());return[(t[0][0]+t[1][0])/2,(t[0][1]+t[1][1])/2]},getCoordinates:function(){return ymaps.geocode(this._schemeView.getScheme().getCity(),{results:1,kind:"locality"}).then(function(t){return ymaps.geocode("metro "+this.title,{results:1,kind:"metro",boundedBy:t.geoObjects.get(0).geometry.getBounds()}).then((function(t){return t.geoObjects.get(0).geometry.getCoordinates()}))}.bind(this))},annotate:function(t,e,o){var n=new i.Deferred;return(t=t||{}).iconColor=this.getNode().getAttribute("fill"),ymaps.modules.require("transportMap.Annotation").spread(function(i){var s=new i(this.getPosition(),t,e);this._annotations.push(s),o||this.getMap().geoObjects.add(s),n.resolve(s)}.bind(this),n.reject.bind(n)),n.promise()}}),t(s)})),ymaps.modules.define("transportMap.StationCollection",["util.augment","vow","Collection","transportMap.Station"],(function(t,e,i,o,n){function s(t,e){s.superclass.constructor.call(this);var i,o,a=t.getScheme().getStations();for(i in this._stationsMap={},a)o=new n(a[i],t),this._stationsMap[i]=o,this.add(o),o.events.setParent(this.events);e&&this.setSelectOnClick(!0)}e(s,o,{setSelectOnClick:function(t){var e=t?"add":"remove";this.each((function(t){t.events[e]("click",this._onStationClick,t)}),this)},_onStationClick:function(){this[this.selected?"deselect":"select"]()},select:function(t){[].concat(t).forEach((function(t){this.getByCode(t).select()}),this)},deselect:function(t){t=t||this.getSelection(),[].concat(t).forEach((function(t){this.getByCode(t).deselect()}),this)},getSelection:function(){var t=[];return this.each((function(e){e.selected&&t.push(e.code)})),t},getByCode:function(t){return this._stationsMap[t]},search:function(t){return new i.fulfill(this.filter((function(e){return e.title.split(" ").some((function(e){return e.substr(0,t.length)===t}))})))}}),t(s)}));